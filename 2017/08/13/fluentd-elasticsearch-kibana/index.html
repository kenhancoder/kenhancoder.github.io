<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><title>使用Fluentd、Elasticsearch、Kibana共同组件一个实时日志分析平台</title><link rel="shortcut icon" href="/images/avatar.png"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css"><script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script></head><body><nav class="main-nav"><a href="/">Home</a><a href="/archives">Archives</a></nav><div class="profile"><section id="wrapper"><header id="header"><a href="/about"><img class="2x" id="avatar" src="/images/avatar.png"></a><h1>0x00hly</h1><h2></h2></header></section></div><section class="post" id="wrapper"><article><header><h1>使用Fluentd、Elasticsearch、Kibana共同组件一个实时日志分析平台</h1><h2 class="headline">8月 13, 2017 10:58·505 words
·2 minutes read<span class="tags"></span></h2></header><section id="post-body"><ul>
<li><p>Elasticsearch是个开源分布式搜索引擎，它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。</p>
</li>
<li><p>Fluentd是一个日志收集系统，它的特点在于其各部分均是可定制化的，你可以通过简单的配置，将日志收集到不同的地方。</p>
</li>
<li><p>Kibana也是一个开源和免费的工具，它Kibana可以为 Logstash 和 ElasticSearch 提供的日志分析友好的 Web 界面，可以帮助您汇总、分析和搜索重要数据日志。</p>
</li>
</ul>
<p>Fluentd的安装在博客中有提及到，在这里变不多讲了<a href="!http://hanliyi.ml/blog/share/fluentd_1.html">地址</a>。Elasticsearch与Kibana的安装详情参考<a href="!http://www.tuicool.com/articles/QFvARfr">地址</a>。</p>
<p>本文中主要是对Fluentd与Elasticsearch的对接进行说明，并创建Python脚本，为Python App来完成日志提交。</p>
<p>Fluentd配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;match project.*&gt;</span><br><span class="line">  type copy</span><br><span class="line">  &lt;store&gt;</span><br><span class="line">    type stdout</span><br><span class="line">    output_type json</span><br><span class="line">  &lt;/store&gt;</span><br><span class="line">  &lt;store&gt;</span><br><span class="line">    type elasticsearch</span><br><span class="line">    host localhost</span><br><span class="line">    port 9200</span><br><span class="line">    index_name project</span><br><span class="line">    type_name project</span><br><span class="line">    flush_interval 5s</span><br><span class="line">    logstash_format true</span><br><span class="line">    logstash_prefix project</span><br><span class="line"> &lt;/store&gt;</span><br><span class="line">&lt;/match&gt;</span><br></pre></td></tr></table></figure></p>
<p>我对match是<code>project.*</code>的日志分别输出到stdout和elasticsearch中。不知道为啥<code>index_name</code>与elasticsearch中的<code>_index</code>不一样。反而logstash_prefix是<code>_index</code>的前缀，并与当前日期拼接成为完整的<code>_index</code>。不知道是否和logstash_format设为true有关，但是如果没有logstash_format这个参数，elasticsearch就接收不到Fluentd的日志。</p>
<p>Python脚本<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> fluent <span class="keyword">import</span> handler</span><br><span class="line"></span><br><span class="line">custom_format = &#123;</span><br><span class="line">    <span class="string">'host'</span>: <span class="string">'%(hostname)s'</span>,</span><br><span class="line">    <span class="string">'where'</span>: <span class="string">'%(module)s.%(funcName)s'</span>,  <span class="comment"># 具体到文件、函数</span></span><br><span class="line">    <span class="string">'loglevel'</span>: <span class="string">'%(levelname)s'</span>,</span><br><span class="line">    <span class="string">'stack_trace'</span>: <span class="string">'%(exc_text)s'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logging.basicConfig(level=logging.ERROR)</span><br><span class="line"></span><br><span class="line">env = os.environ.get(<span class="string">'GOOCANIMSERVICE_ENV'</span>) <span class="keyword">if</span> os.environ.get(</span><br><span class="line">    <span class="string">'GOOCANIMSERVICE_ENV'</span>) <span class="keyword">else</span> <span class="string">'local'</span></span><br><span class="line">l = logging.getLogger(<span class="string">'goocanim.'</span> + env)</span><br><span class="line"></span><br><span class="line">h = handler.FluentHandler(<span class="string">'goocanim.'</span> + env, host=<span class="string">'121.40.99.27'</span>, port=<span class="number">24224</span>)</span><br><span class="line">formatter = handler.FluentRecordFormatter(custom_format)</span><br><span class="line">h.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">l.addHandler(h)</span><br></pre></td></tr></table></figure></p>
<p>需要安装fluent-logger，安装命令<code>pip install fluent-logger</code>。在相应的文件中引用<code>l</code>，使用<code>l.info(...)</code>、<code>l.error(...)</code>等命令，就能将相应的日志输出到Elasticsearch中，并在Kibana中显示。</p>
</section><nav id="post-nav"><span class="prev"><a href="/2017/08/13/programming-is-hard/"><span class="arrow">←</span>Newer Posts</a></span><span class="next"><a href="/2017/08/13/fluentd-1/">Older Posts<span class="arrow">→</span></a></span></nav></article></section><footer id="footer"><div id="social"><a class="symbol" href="https://github.com/kenhancoder"><i class="fa fa-github"></i></a></div><p class="small">© Copyright 2018 &nbsp;<i class="fa fa-heart" aria-hidden="true">&nbsp;Dxx</i></p><p class="small">Powered by &nbsp;<a href="https://hexo.io/">Hexo &nbsp;</a>Theme By &nbsp;<a href="https://github.com/fuzhouxxdong/hexo-theme-dxx">Dxx</a></p></footer><script>hljs.initHighlightingOnLoad();</script></body></html>